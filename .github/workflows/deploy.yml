name: Deploy to Firebase

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '10.26.1'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm build
        env:
          VITE_API_URL: ${{ secrets.BETTER_AUTH_URL }}
          VITE_APP_URL: ${{ secrets.CLIENT_URL }}

      - name: Build Cloud Functions
        run: pnpm --filter @ding/api build:functions

      - name: Prepare Cloud Functions package.json
        run: |
          # Cloud Functions 用に package.json をクリーンアップ
          cd apps/api
          node -e "
            const pkg = require('./package.json');
            delete pkg.devDependencies;
            delete pkg.type;  // ESM 設定を削除（CJS との互換性のため）
            require('fs').writeFileSync('./package.json', JSON.stringify(pkg, null, 2));
          "

      - name: Deploy Cloud Functions
        run: |
          npm install -g firebase-tools
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}' > $HOME/gcloud-key.json
          export GOOGLE_APPLICATION_CREDENTIALS=$HOME/gcloud-key.json

          # Cloud Functions 用の環境変数ファイルを生成
          cat > apps/api/.env.${{ secrets.FIREBASE_PROJECT_ID }} << EOF
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          DATABASE_AUTH_TOKEN=${{ secrets.DATABASE_AUTH_TOKEN }}
          CLIENT_URL=${{ secrets.CLIENT_URL }}
          BETTER_AUTH_URL=${{ secrets.BETTER_AUTH_URL }}
          BETTER_AUTH_SECRET=${{ secrets.BETTER_AUTH_SECRET }}
          GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL=${{ secrets.GEMINI_MODEL }}
          EOF
          # 先頭スペースを削除
          sed -i 's/^[[:space:]]*//' apps/api/.env.${{ secrets.FIREBASE_PROJECT_ID }}

          firebase deploy --only functions --project ${{ secrets.FIREBASE_PROJECT_ID }} --non-interactive --force
          rm -f $HOME/gcloud-key.json

      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          channelId: live
          projectId: ${{ secrets.FIREBASE_PROJECT_ID }}
        env:
          FIREBASE_CLI_EXPERIMENTS: webframeworks
